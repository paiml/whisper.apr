#!/bin/sh
# Generated by Rash v6.43.0
# POSIX-compliant shell script

set -euf
IFS=' 	
'
export LC_ALL=C

# Rash runtime functions
rash_println() {
    printf '%s\n' "$1"
}

rash_require() {
    if ! "$@"; then
        echo "FATAL: Requirement failed: $*" >&2
        exit 1
    fi
}

rash_download_verified() {
    url="$1"; dst="$2"; checksum="$3"
    
    if command -v curl >/dev/null 2>&1; then
        curl -fsSL --proto '=https' --tlsv1.2 "$url" -o "$dst"
    elif command -v wget >/dev/null 2>&1; then
        wget -qO "$dst" "$url"
    else
        echo "FATAL: Neither curl nor wget found" >&2
        return 1
    fi
    
    if command -v sha256sum >/dev/null 2>&1; then
        echo "$checksum  $dst" | sha256sum -c >/dev/null
    elif command -v shasum >/dev/null 2>&1; then
        echo "$checksum  $dst" | shasum -a 256 -c >/dev/null
    else
        echo "FATAL: No checksum utility found" >&2
        return 1
    fi
}

# Rash stdlib functions
rash_string_trim() {
    s="$1"
    # Remove leading whitespace
    s="${s#"${s%%[![:space:]]*}"}"
    # Remove trailing whitespace
    s="${s%"${s##*[![:space:]]}"}"
    printf '%s' "$s"
}

rash_string_contains() {
    haystack="$1"
    needle="$2"
    case "$haystack" in
        *"$needle"*) return 0 ;;
        *) return 1 ;;
    esac
}

rash_string_len() {
    s="$1"
    printf '%s' "$s" | wc -c | tr -d ' '
}

rash_string_replace() {
    s="$1"
    old="$2"
    new="$3"
    # POSIX-compliant string replacement using case/sed fallback
    if [ -z "$old" ]; then
        printf '%s' "$s"
        return
    fi
    # Replace first occurrence using parameter expansion
    printf '%s' "${s%%"$old"*}${new}${s#*"$old"}"
}

rash_string_to_upper() {
    s="$1"
    # POSIX-compliant uppercase conversion
    printf '%s' "$s" | tr '[:lower:]' '[:upper:]'
}

rash_string_to_lower() {
    s="$1"
    # POSIX-compliant lowercase conversion
    printf '%s' "$s" | tr '[:upper:]' '[:lower:]'
}

rash_fs_exists() {
    path="$1"
    test -e "$path"
}

rash_fs_read_file() {
    path="$1"
    if [ ! -f "$path" ]; then
        echo "ERROR: File not found: $path" >&2
        return 1
    fi
    cat "$path"
}

rash_fs_write_file() {
    path="$1"
    content="$2"
    printf '%s' "$content" > "$path"
}

rash_fs_copy() {
    src="$1"
    dst="$2"
    if [ ! -f "$src" ]; then
        echo "ERROR: Source file not found: $src" >&2
        return 1
    fi
    cp "$src" "$dst"
}

rash_fs_remove() {
    path="$1"
    if [ ! -e "$path" ]; then
        echo "ERROR: Path not found: $path" >&2
        return 1
    fi
    rm -f "$path"
}

rash_fs_is_file() {
    path="$1"
    test -f "$path"
}

rash_fs_is_dir() {
    path="$1"
    test -d "$path"
}

rash_string_split() {
    text="$1"
    delimiter="$2"
    # Use tr to replace delimiter with newline for POSIX compliance
    printf '%s\n' "$text" | tr "$delimiter" '\n'
}

rash_array_len() {
    array="$1"
    # Count non-empty lines
    if [ -z "$array" ]; then
        printf '0'
    else
        printf '%s\n' "$array" | wc -l | tr -d ' '
    fi
}

rash_array_join() {
    array="$1"
    separator="$2"
    
    # Read lines and join with separator
    first=1
    result=""
    while IFS= read -r line; do
        if [ "$first" = 1 ]; then
            result="$line"
            first=0
        else
            result="${result}${separator}${line}"
        fi
    done <<EOF
$array
EOF
    printf '%s' "$result"
}

# Main script begins
main() {
        echo '======================================================================'
        echo '           GROUND TRUTH 3-COLUMN COMPARISON (WAPR-QA-GT)              '
        echo '======================================================================'
        echo ''
        echo 'Audio: demos/test-audio/test-speech-1.5s.wav'
        echo ''
        echo 'Running transcription tests...'
        echo ''
        echo '[1/3] whisper.apr:'
        cargo run --release --bin whisper-apr-cli --features cli -- transcribe --model-path models/whisper-tiny.apr -q demos/test-audio/test-speech-1.5s.wav 2>/dev/null || true
        echo ''
        echo '[2/3] whisper.cpp:'
        /home/noah/.local/bin/main -m /home/noah/src/whisper.cpp/models/ggml-tiny.bin -f demos/test-audio/test-speech-1.5s.wav 2>/dev/null || true
        echo ''
        echo '[3/3] HuggingFace (via uv):'
        uv run scripts/hf_transcribe.py demos/test-audio/test-speech-1.5s.wav || true
        echo ''
        echo '======================================================================'
        echo 'Compare outputs above manually or use ground_truth_validate.py'
        echo '======================================================================'
}

# Cleanup on exit
trap 'rm -rf "${TMPDIR:-/tmp}/rash.$$"' EXIT

# Execute main function
main "$@"
