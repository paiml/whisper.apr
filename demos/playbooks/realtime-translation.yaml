# Realtime Translation Demo - State Machine Playbook
# Prevents "whack-a-mole" regressions in multi-language flow
#
# Run: probar playbook demos/playbooks/realtime-translation.yaml --validate

version: "1.0"
name: "Realtime Translation State Machine"
description: "WAPR-DEMO-003: Validates realtime speech translation UI flow"

machine:
  id: "realtime_translation"
  initial: "initializing"

  states:
    initializing:
      id: "initializing"

    loading_model:
      id: "loading_model"

    idle:
      id: "idle"
      invariants:
        - description: "Language selector visible"
          condition: "has_element('#source-language')"
        - description: "Start button enabled"
          condition: "can_start()"

    requesting_permission:
      id: "requesting_permission"

    recording:
      id: "recording"
      invariants:
        - description: "Source transcript updating"
          condition: "has_element('#source-transcript')"
        - description: "Translation output visible"
          condition: "has_element('#translation-output')"

    processing:
      id: "processing"

    error:
      id: "error"

  transitions:
    - id: "init_to_loading"
      from: "initializing"
      to: "loading_model"
      event: "wasm_ready"

    - id: "loading_to_idle"
      from: "loading_model"
      to: "idle"
      event: "model_loaded"

    - id: "idle_to_requesting"
      from: "idle"
      to: "requesting_permission"
      event: "start_clicked"

    - id: "requesting_to_recording"
      from: "requesting_permission"
      to: "recording"
      event: "permission_granted"

    - id: "recording_to_processing"
      from: "recording"
      to: "processing"
      event: "stop_clicked"

    - id: "processing_to_idle"
      from: "processing"
      to: "idle"
      event: "done"

    - id: "requesting_to_error"
      from: "requesting_permission"
      to: "error"
      event: "permission_denied"

    - id: "loading_to_error"
      from: "loading_model"
      to: "error"
      event: "load_failed"

    - id: "recording_to_error"
      from: "recording"
      to: "error"
      event: "audio_error"

    - id: "error_to_idle"
      from: "error"
      to: "idle"
      event: "dismiss"

  forbidden:
    - from: "idle"
      to: "recording"
      reason: "Must request microphone permission first"

    - from: "processing"
      to: "recording"
      reason: "Cannot overlap recording sessions"

    - from: "error"
      to: "recording"
      reason: "Must recover from error first"

    - from: "initializing"
      to: "recording"
      reason: "Model must be loaded first"

performance:
  max_duration_ms: 15000
  max_memory_mb: 250

assertions:
  path:
    must_visit: ["initializing", "idle"]
    must_not_visit: ["error"]
