# Realtime Transcription Demo - State Machine Playbook
# Prevents "whack-a-mole" regressions by validating state transitions
#
# Run: probar playbook demos/playbooks/realtime-transcription.yaml --validate
#
# Performance baseline: trueno 0.8.2 (matmul_wasm_tiled optimization)
# - matmul(384,74,384) < 30ms (Whisper encoder attention)
# - No O(n^2) transpose overhead in WASM

version: "1.0"
name: "Realtime Transcription State Machine"
description: "WAPR-DEMO-001: Validates microphone transcription UI flow"

machine:
  id: "realtime_transcription"
  initial: "initializing"

  states:
    initializing:
      id: "initializing"
      invariants:
        - description: "Start button disabled during init"
          condition: "!can_start_recording()"
        - description: "Stop button disabled during init"
          condition: "!can_stop_recording()"

    loading_model:
      id: "loading_model"
      invariants:
        - description: "Loading indicator visible"
          condition: "has_element('.loading-spinner')"

    idle:
      id: "idle"
      invariants:
        - description: "Start button enabled"
          condition: "can_start_recording()"
        - description: "Stop button disabled"
          condition: "!can_stop_recording()"

    requesting_permission:
      id: "requesting_permission"
      invariants:
        - description: "Permission dialog shown"
          condition: "permission_dialog_visible()"

    recording:
      id: "recording"
      invariants:
        - description: "Stop button enabled"
          condition: "can_stop_recording()"
        - description: "Start button disabled"
          condition: "!can_start_recording()"
        - description: "Recording indicator visible"
          condition: "has_element('.recording-indicator')"
        - description: "Transcript container exists"
          condition: "has_element('#transcript')"
        - description: "Transcription updates within 5s"
          condition: "transcript_text_changes_within(5000)"

    processing:
      id: "processing"
      invariants:
        - description: "Processing indicator visible"
          condition: "has_element('.processing')"

    error:
      id: "error"
      invariants:
        - description: "Error message visible"
          condition: "error_message().is_some()"

  transitions:
    # Happy path: Init -> Load -> Idle -> Request -> Record -> Process -> Idle
    - id: "init_to_loading"
      from: "initializing"
      to: "loading_model"
      event: "wasm_ready"

    - id: "loading_to_idle"
      from: "loading_model"
      to: "idle"
      event: "model_loaded"

    - id: "idle_to_requesting"
      from: "idle"
      to: "requesting_permission"
      event: "start_clicked"

    - id: "requesting_to_recording"
      from: "requesting_permission"
      to: "recording"
      event: "permission_granted"

    - id: "recording_to_processing"
      from: "recording"
      to: "processing"
      event: "stop_clicked"

    - id: "processing_to_idle"
      from: "processing"
      to: "idle"
      event: "processing_complete"

    # Error paths
    - id: "requesting_to_error"
      from: "requesting_permission"
      to: "error"
      event: "permission_denied"

    - id: "loading_to_error"
      from: "loading_model"
      to: "error"
      event: "model_load_failed"

    - id: "init_to_error"
      from: "initializing"
      to: "error"
      event: "wasm_load_failed"

    - id: "recording_to_error"
      from: "recording"
      to: "error"
      event: "audio_error"

    - id: "recording_to_error_timeout"
      from: "recording"
      to: "error"
      event: "transcription_timeout"
      guard: "no_transcript_update_for(10000)"

    # Recovery paths
    - id: "error_to_idle"
      from: "error"
      to: "idle"
      event: "dismiss_error"

    - id: "error_to_loading"
      from: "error"
      to: "loading_model"
      event: "retry_load"

  # CRITICAL: Forbidden transitions that would indicate bugs
  forbidden:
    - from: "idle"
      to: "recording"
      reason: "Cannot skip permission request - would cause audio errors"

    - from: "processing"
      to: "recording"
      reason: "Cannot start recording while processing - would lose data"

    - from: "error"
      to: "recording"
      reason: "Cannot record from error state - must recover first"

    - from: "error"
      to: "processing"
      reason: "Cannot process from error state - invalid flow"

    - from: "initializing"
      to: "recording"
      reason: "Cannot record before WASM initialized"

    - from: "initializing"
      to: "idle"
      reason: "Cannot skip model loading"

  # Invariant violations that indicate bugs
  invariant_violations:
    - state: "recording"
      condition: "recording_duration() > 5000 && transcript_empty()"
      reason: "Recording for 5s+ with no transcript output indicates worker/model failure"

    - state: "recording"
      condition: "chunks_sent() > 3 && chunks_processed() == 0"
      reason: "Audio chunks sent but none processed - worker communication broken"

performance:
  # Session constraints
  max_duration_ms: 10000
  max_memory_mb: 200

  # Latency targets (trueno 0.8.2 baseline)
  first_transcript_latency_ms: 3000      # Tightened from 5000ms
  first_transcript_latency_critical_ms: 5000  # Tightened from 10000ms

  # Real-Time Factor (processing_time / audio_duration)
  # trueno 0.8.2: matmul < 30ms enables RTF < 1.5 for Whisper tiny
  rtf_target: 1.5        # Tightened from 2.0
  rtf_critical: 2.0      # Tightened from 4.0

  # Chunk processing (1.5s audio chunks)
  chunk_processing_ms: 1500    # Tightened from 2000ms
  chunk_processing_critical_ms: 3000  # Tightened from 5000ms

  # Matmul performance (trueno 0.8.2 baseline)
  matmul_384x74x384_ms: 30     # Whisper encoder attention
  matmul_critical_ms: 100      # Critical threshold

  # Queue constraints
  max_queue_depth: 3
  drop_tolerance: 0  # Zero tolerance for dropped chunks

# Performance assertions (testable conditions)
# Updated for trueno 0.8.2 matmul_wasm_tiled optimization
performance_assertions:
  - name: "first_transcript_latency"
    condition: "first_transcript_latency_ms() <= 3000"
    critical: "first_transcript_latency_ms() <= 5000"
    failure_reason: "Transcription pipeline too slow or hanging"

  - name: "realtime_factor"
    condition: "rtf() <= 1.5"
    critical: "rtf() <= 2.0"
    failure_reason: "Processing slower than realtime threshold"

  - name: "chunk_processing"
    condition: "chunk_processing_ms() <= 1500"
    critical: "chunk_processing_ms() <= 3000"
    failure_reason: "Chunk processing exceeds audio duration"

  - name: "matmul_performance"
    condition: "matmul_384x74x384_ms() <= 30"
    critical: "matmul_384x74x384_ms() <= 100"
    failure_reason: "Matrix multiplication regression - check trueno version"

  - name: "no_drops"
    condition: "chunks_dropped() == 0"
    failure_reason: "Audio chunks dropped - worker cannot keep up"

  - name: "queue_bounded"
    condition: "queue_depth() <= 3"
    failure_reason: "Queue overflow indicates backpressure"
