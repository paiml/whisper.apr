#!/usr/bin/env python3
"""Generate Rust constants for OpenAI's mel filterbank.

Downloads mel_filters.npz from OpenAI's whisper repo and generates
Rust code with the filterbank as a static constant.

Usage:
    python3 tools/generate_filterbank_const.py > src/audio/mel_filterbank_data.rs
"""

import numpy as np
import urllib.request
import io
import sys

# OpenAI Whisper mel filters URL
MEL_FILTERS_URL = "https://raw.githubusercontent.com/openai/whisper/main/whisper/assets/mel_filters.npz"

def download_mel_filters():
    """Download mel_filters.npz from OpenAI's repo."""
    print(f"// Downloading from {MEL_FILTERS_URL}", file=sys.stderr)
    with urllib.request.urlopen(MEL_FILTERS_URL) as response:
        data = response.read()
    return np.load(io.BytesIO(data))

def format_f32_array(arr, name, indent=4):
    """Format numpy array as Rust static array."""
    flat = arr.flatten()
    lines = []
    lines.append(f"/// {name} filterbank from OpenAI Whisper")
    lines.append(f"/// Shape: {arr.shape}")
    lines.append(f"/// Generated from: {MEL_FILTERS_URL}")
    lines.append(f"pub static {name.upper()}_FILTERBANK: [f32; {len(flat)}] = [")

    # Format in chunks of 8 values per line
    chunk_size = 8
    for i in range(0, len(flat), chunk_size):
        chunk = flat[i:i+chunk_size]
        values = ", ".join(f"{v:.8e}" for v in chunk)
        lines.append(" " * indent + values + ",")

    lines.append("];")
    lines.append("")
    return "\n".join(lines)

def main():
    filters = download_mel_filters()

    print("//! Pre-computed mel filterbank from OpenAI Whisper")
    print("//!")
    print("//! These filterbanks are generated using `librosa.filters.mel()` with")
    print("//! slaney normalization. Each row sums to approximately 0.025 (area-normalized).")
    print("//!")
    print("//! IMPORTANT: Do not compute these at runtime - use these constants to ensure")
    print("//! exact numerical match with OpenAI's implementation.")
    print("//!")
    print("//! Generated by: tools/generate_filterbank_const.py")
    print("")
    print(f"/// Number of mel bands for standard Whisper models")
    print(f"pub const N_MELS_80: usize = 80;")
    print(f"pub const N_MELS_128: usize = 128;")
    print(f"")
    print(f"/// Number of frequency bins (n_fft/2 + 1 = 400/2 + 1 = 201)")
    print(f"pub const N_FREQS: usize = 201;")
    print("")

    # Generate mel_80 (standard whisper models)
    mel_80 = filters["mel_80"]
    print(f"// mel_80 shape: {mel_80.shape}", file=sys.stderr)
    print(f"// mel_80 sum: {mel_80.sum():.6f}", file=sys.stderr)
    print(f"// mel_80 row 0 sum: {mel_80[0].sum():.6f}", file=sys.stderr)
    print(format_f32_array(mel_80, "MEL_80"))

    # Generate mel_128 (large-v3 models)
    mel_128 = filters["mel_128"]
    print(f"// mel_128 shape: {mel_128.shape}", file=sys.stderr)
    print(f"// mel_128 sum: {mel_128.sum():.6f}", file=sys.stderr)
    print(format_f32_array(mel_128, "MEL_128"))

if __name__ == "__main__":
    main()
